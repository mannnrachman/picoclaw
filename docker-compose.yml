services:
  # ─────────────────────────────────────────────
  # PicoClaw Agent (one-shot query)
  #   docker compose run --rm picoclaw-agent -m "Hello"
  # ─────────────────────────────────────────────
  picoclaw-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-agent
    network_mode: host
    profiles:
      - agent
    volumes:
      - ./config/config.json:/home/picoclaw/.picoclaw/config.json:ro
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    entrypoint: ["picoclaw", "agent"]
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  # ─────────────────────────────────────────────
  # PicoClaw Gateway (Long-running Bot)
  #   docker compose up picoclaw-gateway
  # ─────────────────────────────────────────────
  picoclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-gateway
    network_mode: host
    restart: unless-stopped
    profiles:
      - gateway
    volumes:
      # Configuration file
      - ./config/config.json:/home/picoclaw/.picoclaw/config.json:ro
      # Persistent workspace (sessions, memory, logs)
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    command: ["gateway"]
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  # ─────────────────────────────────────────────
  # Jaeger (Tracing UI + OTLP collector)
  #   UI: http://localhost:16686
  # ─────────────────────────────────────────────
  jaeger:
    image: jaegertracing/jaeger:2
    container_name: picoclaw-jaeger
    profiles:
      - tracing
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
    environment:
      - COLLECTOR_OTLP_ENABLED=true

volumes:
  picoclaw-workspace:
